<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Integra√ß√£o - SDK no Navegador</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 20px 0; padding: 15px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üß™ Teste de Integra√ß√£o da SDK no Navegador</h1>
    
    <div id="status" class="test-section">
        <h3>Status da Integra√ß√£o</h3>
        <div id="integration-status">Carregando...</div>
    </div>

    <div id="tracking-tests" class="test-section">
        <h3>Testes de Capta√ß√£o de Comportamentos</h3>
        <button onclick="testClientEvent()">Testar Evento de Cliente</button>
        <button onclick="testProductEvent()">Testar Evento de Produto</button>
        <button onclick="testSearchEvent()">Testar Evento de Busca</button>
        <button onclick="testWishlistEvent()">Testar Wishlist</button>
        <button onclick="testWarnMeEvent()">Testar Warn Me</button>
        <div id="tracking-results"></div>
    </div>

    <div id="cookies-section" class="test-section">
        <h3>Verifica√ß√£o de Cookies de Tracking</h3>
        <button onclick="checkTrackingCookies()">Verificar Cookies</button>
        <div id="cookies-status"></div>
    </div>

    <div id="url-detection" class="test-section">
        <h3>Detec√ß√£o Autom√°tica de P√°ginas</h3>
        <button onclick="simulateProductPage()">Simular P√°gina de Produto</button>
        <button onclick="simulateSearchPage()">Simular P√°gina de Busca</button>
        <div id="url-results"></div>
    </div>

    <!-- Carrega a SDK compilada (webpack) -->
    <script src="./dist/main.49d013975f6a02a9b0ee.min.js"></script>
    
    <script>
        // Configura√ß√µes de teste
        const TEST_BTG_ID = '123:456';
        const TEST_TCS_TOKEN = 'tcs_test_12345678901234567890123456789012';
        let testResults = [];

        function logResult(test, success, message) {
            const result = { test, success, message, timestamp: new Date() };
            testResults.push(result);
            console.log(`${success ? '‚úÖ' : '‚ùå'} ${test}: ${message}`);
            return result;
        }

        function displayStatus(elementId, content, className = '') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            if (className) element.className = className;
        }

        // Verifica se a SDK foi carregada corretamente
        function checkSDKIntegration() {
            const checks = [];
            
            // Verifica se BtgTracking est√° dispon√≠vel globalmente
            if (typeof window.BtgTracking !== 'undefined') {
                checks.push('‚úÖ window.BtgTracking dispon√≠vel');
            } else {
                checks.push('‚ùå window.BtgTracking n√£o encontrado');
            }

            // Verifica se BtgSend est√° dispon√≠vel globalmente
            if (typeof window.BtgSend !== 'undefined') {
                checks.push('‚úÖ window.BtgSend dispon√≠vel');
            } else {
                checks.push('‚ùå window.BtgSend n√£o encontrado');
            }

            // Verifica m√©todos essenciais
            if (window.BtgTracking && typeof window.BtgTracking.start === 'function') {
                checks.push('‚úÖ M√©todo start() dispon√≠vel');
            } else {
                checks.push('‚ùå M√©todo start() n√£o encontrado');
            }

            // Verifica se cookies est√£o sendo gerenciados
            if (document.cookie.includes('__bid')) {
                checks.push('‚úÖ Cookie BID detectado');
            } else {
                checks.push('‚ö†Ô∏è Cookie BID n√£o encontrado (normal antes da inicializa√ß√£o)');
            }

            displayStatus('integration-status', checks.join('<br>'));
            return checks.filter(c => c.startsWith('‚úÖ')).length >= 3;
        }

        // Testa inicializa√ß√£o da SDK
        async function initializeSDK() {
            try {
                if (window.BtgTracking && window.BtgTracking.start) {
                    await window.BtgTracking.start(TEST_BTG_ID, TEST_TCS_TOKEN);
                    logResult('Inicializa√ß√£o', true, 'SDK inicializada com sucesso');
                    return true;
                } else {
                    logResult('Inicializa√ß√£o', false, 'M√©todos da SDK n√£o dispon√≠veis');
                    return false;
                }
            } catch (error) {
                logResult('Inicializa√ß√£o', false, `Erro na inicializa√ß√£o: ${error.message}`);
                return false;
            }
        }

        // Testes de eventos espec√≠ficos
        function testClientEvent() {
            try {
                window.BtgSend(TEST_BTG_ID, 'client', [{
                    email: 'teste@exemplo.com',
                    phone: '11999999999'
                }], null, null);
                logResult('Evento Cliente', true, 'Evento de cliente enviado');
                displayStatus('tracking-results', '√öltimo teste: Evento Cliente - ‚úÖ Sucesso', 'success');
            } catch (error) {
                logResult('Evento Cliente', false, error.message);
                displayStatus('tracking-results', `√öltimo teste: Evento Cliente - ‚ùå ${error.message}`, 'error');
            }
        }

        function testProductEvent() {
            try {
                const productData = {
                    productId: '123',
                    productName: 'Produto Teste',
                    productBrand: { name: 'Marca Teste' },
                    productCategories: [
                        { name: 'Categoria 1' },
                        { name: 'Categoria 2' }
                    ],
                    prices: {
                        priceTables: [{ price: '99.99' }]
                    }
                };
                
                window.BtgSend(TEST_BTG_ID, 'product', productData, productData.productCategories, null);
                logResult('Evento Produto', true, 'Evento de produto enviado');
                displayStatus('tracking-results', '√öltimo teste: Evento Produto - ‚úÖ Sucesso', 'success');
            } catch (error) {
                logResult('Evento Produto', false, error.message);
                displayStatus('tracking-results', `√öltimo teste: Evento Produto - ‚ùå ${error.message}`, 'error');
            }
        }

        function testSearchEvent() {
            try {
                window.BtgSend(TEST_BTG_ID, 'search', [{ keyword: 'produto teste' }], null, null);
                logResult('Evento Busca', true, 'Evento de busca enviado');
                displayStatus('tracking-results', '√öltimo teste: Evento Busca - ‚úÖ Sucesso', 'success');
            } catch (error) {
                logResult('Evento Busca', false, error.message);
                displayStatus('tracking-results', `√öltimo teste: Evento Busca - ‚ùå ${error.message}`, 'error');
            }
        }

        function testWishlistEvent() {
            try {
                // Simula fun√ß√£o global de wishlist
                window.originalWishlistAddClick = window.wishlistAddClick || function() { 
                    console.log('Wishlist original chamada'); 
                };
                
                // Chama a fun√ß√£o para testar intercepta√ß√£o
                if (typeof window.wishlistAddClick === 'function') {
                    window.wishlistAddClick();
                }
                
                logResult('Wishlist', true, 'Intercepta√ß√£o de wishlist testada');
                displayStatus('tracking-results', '√öltimo teste: Wishlist - ‚úÖ Intercepta√ß√£o testada', 'success');
            } catch (error) {
                logResult('Wishlist', false, error.message);
                displayStatus('tracking-results', `√öltimo teste: Wishlist - ‚ùå ${error.message}`, 'error');
            }
        }

        function testWarnMeEvent() {
            try {
                // Simula fun√ß√£o global de warn me
                window.originalBackInStockOnClick = window.backInStockOnClick || function() { 
                    console.log('BackInStock original chamada'); 
                };
                
                // Chama a fun√ß√£o para testar intercepta√ß√£o
                if (typeof window.backInStockOnClick === 'function') {
                    window.backInStockOnClick();
                }
                
                logResult('WarnMe', true, 'Intercepta√ß√£o de warn me testada');
                displayStatus('tracking-results', '√öltimo teste: Warn Me - ‚úÖ Intercepta√ß√£o testada', 'success');
            } catch (error) {
                logResult('WarnMe', false, error.message);
                displayStatus('tracking-results', `√öltimo teste: Warn Me - ‚ùå ${error.message}`, 'error');
            }
        }

        function checkTrackingCookies() {
            const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                const [key, value] = cookie.trim().split('=');
                acc[key] = value;
                return acc;
            }, {});

            const trackingCookies = ['__bid', '__btgUtms', '__btgModule'];
            const cookieStatus = trackingCookies.map(cookieName => {
                const exists = cookies[cookieName];
                return `${cookieName}: ${exists ? '‚úÖ Presente' : '‚ùå Ausente'}`;
            });

            displayStatus('cookies-status', cookieStatus.join('<br>'));
            logResult('Cookies', true, 'Verifica√ß√£o de cookies realizada');
        }

        function simulateProductPage() {
            // Muda temporariamente a URL para simular detec√ß√£o
            const originalPath = window.location.pathname;
            history.pushState({}, '', '/produto/teste-produto-123');
            
            logResult('Detec√ß√£o URL', true, 'Simula√ß√£o de p√°gina de produto');
            displayStatus('url-results', 'Simulando: /produto/teste-produto-123 - ‚úÖ URL alterada', 'success');
            
            setTimeout(() => {
                history.pushState({}, '', originalPath);
                displayStatus('url-results', 'URL restaurada para o valor original', 'warning');
            }, 3000);
        }

        function simulateSearchPage() {
            const originalPath = window.location.pathname;
            history.pushState({}, '', '/busca?busca=produto-teste');
            
            logResult('Detec√ß√£o URL', true, 'Simula√ß√£o de p√°gina de busca');
            displayStatus('url-results', 'Simulando: /busca?busca=produto-teste - ‚úÖ URL alterada', 'success');
            
            setTimeout(() => {
                history.pushState({}, '', originalPath);
                displayStatus('url-results', 'URL restaurada para o valor original', 'warning');
            }, 3000);
        }

        // Inicializa√ß√£o autom√°tica
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Iniciando testes de integra√ß√£o da SDK...');
            
            setTimeout(async () => {
                const integrationOK = checkSDKIntegration();
                
                if (integrationOK) {
                    console.log('‚úÖ Integra√ß√£o b√°sica OK, tentando inicializar...');
                    await initializeSDK();
                } else {
                    console.error('‚ùå Problemas na integra√ß√£o b√°sica');
                }
                
                // Mostra resumo
                console.log('üìä Resumo dos testes:', testResults);
            }, 1000);
        });
    </script>
</body>
</html> 